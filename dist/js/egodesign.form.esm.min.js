const t=({element:t,enter:e,time:s,displayType:i,callback:r})=>{t.style.opacity=e?0:1,e&&(t.style.display=i||"block");let a=+new Date;!function i(){t.style.opacity=e?+t.style.opacity+(new Date-a)/(s||200):+t.style.opacity-(new Date-a)/(s||200),a=+new Date,e&&+t.style.opacity<1||!e&&+t.style.opacity>0?window.requestAnimationFrame&&requestAnimationFrame(i)||setTimeout(i,16):(e||(t.style.display="none"),r&&"function"==typeof r&&r())}()},e=({element:t,className:e})=>{if(!t)return!1;for(;t&&!t.classList.contains(e);)t=!!t.parentElement&&t.parentElement;return t};function s(t,e="log"){"log"==e?console.log("::EgoForm:: "+t):"data"==e&&(console.log("::EgoForm:: DATA"),console.table(t))}const i={default:{empty:"Campo requerido.",invalid:"Campo nó válido.",minLength:"Debe tener al menos [[var]] caracteres.",maxLength:"Debe tener como máximo [[var]] caracteres."},email:{empty:"El email es requerido.",invalid:"El email no es válido."},message:{empty:"El mensaje es requerido."},password:{empty:"Ingrese una contraseña."},password_repeat:{empty:"Debe repetir la contraseña.",unequal:"Las contraseñas no coindicen."},cuil:{empty:"Campo requerido.",min:"El número debe tener exactamente 11 dígitos.",invalid:"El número ingresado no es válido."},url:{empty:"Campo requerido.",invalid:"URL no válida."},file:{empty:"Campo requerido",min_size:"El tamaño mínimo es [[var]]",max_size:"El tamaño máximo es [[var]]"}};class r{constructor({customValidations:t,classes:e,customValidationMessages:s,debug:r}){this.customValidations=t,this.validationMessages={...i,...s}||i,this.classes=e,this.debug=r}validateField(t){const e=t.dataset.type,i=["radio","checkbox"].includes(e),r=t.classList.contains(this.classes.requiredField),a=t.classList.contains(this.classes.requiredIfFilledField),o=t.querySelector(".form__error"),l=t.querySelector(".form__control"),n=i?t.querySelector(".form__control:checked"):null,u=l?l.getAttribute("name"):"",d=Object.keys(this.customValidations),c=t.dataset.minLength?parseInt(t.dataset.minLength):null,h=t.dataset.maxLength?parseInt(t.dataset.maxLength):null;if(l||this.throwError("control not found."),u||this.throwError("control name not found."),this.debug&&s(`validating field "${u}"`),r&&!l.value)return o&&(o.textContent=this.validationMessages[u]?this.validationMessages[u].empty:this.validationMessages.default.empty),this.displayFieldError(l,t,o),!1;if(l.value){if(c&&l.value.length<c)return o&&(o.textContent=this.validationMessages.default.minLength.replace("[[var]]",c)),this.displayFieldError(l,t,o),!1;if(h&&l.value.length>h)return o&&(o.textContent=this.validationMessages.default.maxLength.replace("[[var]]",h)),this.displayFieldError(l,t,o),!1}if(i&&!n){if(!a)return this.displayFieldError(l,t,o),o&&(o.textContent=this.validationMessages[u]?this.validationMessages[u].empty:this.validationMessages.default.empty),!1}else{switch(e){case"email":if(l.value&&!this.isValidEmail(l.value))return o&&(o.textContent=this.validationMessages.email.invalid),this.displayFieldError(l,t,o),!1;break;case"password_repeat":{const e=document.getElementById("password");if(e&&l.value!=e.value)return o&&(o.textContent=this.validationMessages.password_repeat.unequal),this.displayFieldError(l,t,o),!1;break}case"cuil":case"cuit":if(l.value&&!this.isValidCuitCuil(l.value))return o&&(o.textContent=this.validationMessages.cuil.invalid),this.displayFieldError(l,t,o),!1;break;case"url":if(l.value&&!this.isValidUrl(l.value))return o&&(o.textContent=this.validationMessages.url.invalid),this.displayFieldError(l,t,o),!1;break;case"money":const e=l.dataset.currency?l.dataset.currency:"$";if(""==l.value||l.value==e)return o&&(o.textContent=this.validationMessages.default.empty),this.displayFieldError(l,t,o),!1;break;case"single-checkbox":if(!l.checked)return this.displayFieldError(l,t,o),o&&(o.textContent=this.validationMessages[u]?this.validationMessages[u].empty:this.validationMessages.default.empty),!1}for(const s of d)if(e===s)for(const s of this.customValidations[e])if(!s.condition(l.value))return o&&(o.textContent=s.message||""),this.displayFieldError(l,t,o),!1}return!0}isValidEmail(t){return/(?!.*\.{2})^([a-z\d!#$%&'*+\-/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([\t]*\r\n)?[\t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([\t]*\r\n)?[\t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i.test(t.toLowerCase())}isValidCuitCuil(t){const e=[5,4,3,2,7,6,5,4,3,2];let s=t.toString().replace(/[^0-9]/g,"").split("");if(11!=s.length)return!1;s=s.map((t=>parseInt(t)));const i=parseInt(s.pop());let r=11-s.reduce(((t,s,i)=>t+s*e[i]),0)%11;return 10==r&&(r=9),11==r&&(r=0),r==i}isValidUrl(t){return!!new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i").test(t)}isValidFileSize(t){let e=null;const s=t.querySelector(".form__control"),i=parseFloat(t.dataset.minSize),r=parseFloat(t.dataset.maxSize),a=t.querySelector(".form__error"),o=s.files[0].name,l=s.files[0].size,n=parseFloat(s.files.length?(l/1048576).toFixed(1):0);n>r||!l?(s.value="",t.classList.remove("--has-file"),s.setAttribute("aria-invalid","true"),t.classList.add(this.classes.fieldHasError)):o?(this.hasFile=!0,t.classList.add("--has-file")):(this.hasFile=!1,t.classList.remove("--has-file")),l?n<i?e=this.validationMessages.file.min_size.replace("[[var]]",i+" MB"):n>r&&(e=this.validationMessages.file.max_size.replace("[[var]]",r+" MB")):e=this.validationMessages.file.empty,e&&(a.textContent=e,this.displayFieldError(s,t,a))}displayFieldError(t,e,s){t.setAttribute("aria-invalid","true"),e.classList.add(this.classes.fieldHasError),this.classes.controlHasError&&t.classList.add(this.classes.controlHasError),s&&s.classList.remove(this.classes.hiddenErrorMessage)}clearControlError(t){t.setAttribute("aria-invalid","false"),this.classes.controlHasError&&t.classList.remove(this.classes.controlHasError);const s=e({element:t,className:"form__field"}),i=s.querySelector(".form__error");s.classList.remove(this.classes.fieldHasError),i&&(i.textContent="",i.classList.add(this.classes.hiddenErrorMessage))}realTimeValidations(t){t.querySelectorAll('.form__field[data-type="file"]').forEach((t=>{const e=t.querySelector(".form__control");e?.addEventListener("change",(e=>{e.stopPropagation(),this.isValidFileSize(t)}))}))}throwError(t){throw new Error(`EgoForm Error: ${t}`)}}class a{constructor({element:t,classes:e,submitType:i,submitDataFormat:a,requestHeaders:o,fieldGroups:l,serializerIgnoreList:n,customValidations:u,customValidationMessages:d,onStepChange:c,onValidationError:h,onSubmitStart:m,onSubmitEnd:f,onSuccess:p,onError:F,onBeforeSubmit:v,resetOnSuccess:g,resetLoaderOnSuccess:y,scrollOnError:E,preventSubmit:S,debug:b}){this.form=t,this.submitType=i||"fetch",this.submitDataFormat=a||"formData",this.requestHeaders=o||{},this.actionUrl=this.form.getAttribute("action"),this.submitMethod=this.form.getAttribute("method")||"POST",this.submitBtn=this.form.querySelector('button[type="submit"]')||null,this.classes={requiredField:"--required",requiredIfFilledField:"--required-if-filled",fieldHasError:"--has-error",controlHasError:!1,hiddenErrorMessage:"--hidden",formSubmittingState:"--submitting",buttonSubmittingState:"--loading",clearFieldError:"--clear-error",validateOnBlur:"--validate-onblur",validateOnInput:"--validate-oninput",...e},this.isValid=!0,this.validator=new r({customValidations:u||{},classes:this.classes,customValidationMessages:d||null,debug:b}),this.onValidationError=h??!1,this.onStepChange=c??!1,this.onSubmitStart=m??!1,this.onSubmitEnd=f??!1,this.onSuccess=p??!1,this.onError=F??!1,this.onBeforeSubmit=v??!1,this.fieldGroups=l??!1,this.hasFile=!1,this.serializerIgnoreList=n||[],this.resetOnSuccess=g??!0,this.resetLoaderOnSuccess=y??!0,this.scrollOnError=E??!0,this.currentStep=this.form.querySelector(".form__step")?parseInt(this.form.querySelector(".form__step.--active").dataset.step):0,this.currentStepOptional=!1,this.stepChanging=!1,this.preventSubmit=S??!1,this.debug=b??!1,this.declareHandlers(),this.debug&&s("initialized!")}submit(){this.preventSubmit||this.resumeSubmit()}resumeSubmit(){this.debug&&s(`submitting using ${this.submitType}!`),this.submittingForm(!0),this.isValid=!0;const t=[];if(this.form.querySelectorAll(".form__field").forEach((e=>{this.validator.validateField(e)||(t.push(e.querySelector(".form__control")?.name),this.isValid=!1)})),this.isValid)this.debug?(s("the form was submitted!"),s(this.serializeData(),"data"),setTimeout((()=>{this.submittingForm(!1,!0)}),1e3)):"fetch"==this.submitType?fetch(this.actionUrl,{method:this.submitMethod,headers:"json"===this.submitDataFormat?{"Content-Type":"application/json",...this.requestHeaders}:{...this.requestHeaders},body:"json"===this.submitDataFormat?JSON.stringify(this.serializeData()):this.serializeData(!0)}).then((t=>{200===t.status||201===t.status?(this.resetOnSuccess&&this.reset(),"function"==typeof this.onSuccess&&this.onSuccess(t)):"function"==typeof this.onError&&this.onError(t)})).catch((t=>{"function"==typeof this.onError&&this.onError(t)})).finally((()=>{this.submittingForm(!1)})):this.form.submit();else if(this.submittingForm(!1,!0),"function"==typeof this.onValidationError&&this.onValidationError(t),this.debug&&s(`this fields have failed validation: ${t.toString().replace(/,/g,", ")}.`),this.scrollOnError){const t=this.form.querySelector(`.form__field.${this.classes.fieldHasError}`);(t=>{const e=t.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth)})(t)||t.scrollIntoView({behavior:"smooth"})}}submittingForm(t,e=!1){let s=document.getElementsByTagName("body").item(0);t?(this.form.classList.add(this.classes.formSubmittingState),this.submitBtn.classList.add(this.classes.buttonSubmittingState),s.classList.add("--block"),"function"==typeof this.onSubmitStart&&this.onSubmitStart()):((this.resetLoaderOnSuccess||e)&&(this.form.classList.remove(this.classes.formSubmittingState),this.submitBtn.classList.remove(this.classes.buttonSubmittingState),s.classList.remove("--block")),"function"==typeof this.onSubmitEnd&&this.onSubmitEnd())}serializeData(t=!1){const e=new FormData(this.form),s={};for(const t of e)if(!this.serializerIgnoreList.includes(t[0])){if(t[1]instanceof File&&!t[1].size&&!t[1].name)continue;s[t[0]]=t[1]}if(this.fieldGroups)for(const t in this.fieldGroups)if(Object.hasOwnProperty.call(this.fieldGroups,t)){let i=[{}];for(const r of this.fieldGroups[t])i[0][r]=e.get(r),delete s[r];s[t]=i}return t?e:s}reset(){this.form.reset(),this.form.querySelectorAll(".form__field").forEach((t=>t.classList.remove("--filled",`${this.classes.fieldHasError}`))),this.form.querySelectorAll(".form__control").forEach((t=>t.setAttribute("aria-invalid","false"))),this.currentStep&&this.changeStep(1)}changeStep(e){if(!this.stepChanging){const s=this.currentStepOptional?this.currentStep+"b":this.currentStep,i=this.form.querySelector('[data-step="'+s+'"]'),r=i.querySelectorAll(`.${this.classes.requiredField}`),a="next"===e?this.currentStep+1:"prev"!==e||this.currentStepOptional?"optional"===e?this.currentStep+"b":this.currentStep:this.currentStep-1,o=this.form.querySelector('[data-step="'+a+'"]');(this.currentStep!==a||this.currentStepOptional)&&(this.stepChanging=!0,this.isValid=!0,setTimeout((()=>{!r||"next"!==e&&"optional"!==e||r.forEach((t=>{this.validator.validateField(t)||(this.isValid=!1)})),i&&o&&this.isValid?t({element:i,enter:!1,time:200,displayType:"flex",callback:()=>{i.classList.remove("--active"),t({element:o,enter:!0,time:200,displayType:"flex",callback:()=>{o.classList.add("--active"),this.stepChanging=!1,this.currentStepOptional="optional"===e,this.currentStep=parseInt(a),"function"==typeof this.onStepChange&&this.onStepChange(s,a)}})}}):this.stepChanging=!1}),50))}}nextStep(){this.changeStep("next")}optionalStep(){this.changeStep("optional")}prevStep(){this.changeStep("prev")}isControlFilled(t){let e=t.parentElement;""!==t.value?e.classList.add("--filled"):e.classList.remove("--filled")}filterNumber(t,e=[]){const s=e.join(""),i=new RegExp("[^"+s+"0-9]","g");return t.toString().replace(i,"")}filterFormattedQuantity(t,e=".",s=",",i){const r=s?t.toString().split(s):[t],a=r[0].replace(/\B(?=(\d{3})+(?!\d))/g,e);let o="";return o=i>0&&r[1]&&r[1].length?a+s+r[1].slice(0,i):a,o}filterMoneyAmount(t,e="$",s=".",i=",",r){if(!t||t==e)return"";let a=this.filterNumber(t,[i||""]);return a=this.filterFormattedQuantity(a,s,i,r),`${e} ${a}`}filterPhoneNumber(t){return t.replace(/[^\d+\-() ]*/g,"")}togglePasswordVisibility(t){this.debug&&s("Password visibility toggled!");const e=t.parentElement.querySelector(".form__control");if(e){const s="password"===e.getAttribute("type")?"text":"password";e.setAttribute("type",s),t.classList.toggle("--hide")}}declareHandlers(){const t=this;if(!this.submitBtn)throw new Error(`There's no submit button in this form "${this.form.id}".`);this.submitBtn.addEventListener("click",(function(e){e.preventDefault(),"function"==typeof t.onBeforeSubmit&&t.onBeforeSubmit(),t.submit()})),this.validator.realTimeValidations(this.form),this.form.querySelectorAll(`.form__field.${this.classes.validateOnBlur}`).forEach((t=>{t.querySelector(".form__control").addEventListener("blur",(()=>{this.validator.validateField(t)||(this.isValid=!1)}))})),this.form.querySelectorAll(`.form__field.${this.classes.validateOnInput}`).forEach((t=>{const e=t.querySelector(".form__control");e.addEventListener("input",(()=>{this.validator.validateField(t)&&this.validator.clearControlError(e)}))})),this.form.querySelectorAll(".form__next-step").forEach((e=>{e.addEventListener("click",t.nextStep.bind(t))})),this.form.querySelectorAll(".form__optional-step").forEach((e=>{e.addEventListener("click",t.optionalStep.bind(t))})),this.form.querySelectorAll(".form__prev-step").forEach((e=>{e.addEventListener("click",t.prevStep.bind(t))})),this.form.querySelectorAll(".form__control").forEach((t=>{this.isControlFilled(t),t.addEventListener("keyup",(()=>{this.isControlFilled(t)})),t.addEventListener("change",(()=>{this.isControlFilled(t)}))})),this.form.querySelectorAll(".form__control").forEach((t=>{t.addEventListener("focus",(()=>{this.validator.clearControlError(t)}))})),this.form.querySelectorAll("."+this.classes.clearFieldError).forEach((s=>{s.addEventListener("click",(()=>{const i=e({element:s,className:"form__field"});t.validator.clearControlError(i.querySelector(".form__control"))}))})),this.form.querySelectorAll(".form__field.--number input").forEach((t=>{const s=this,i=e({element:t,className:"form__field"}),r=i&&i.dataset.thousandsSeparator?i.dataset.thousandsSeparator:null,a=i&&i.dataset.decimalSeparator?i.dataset.decimalSeparator:"",o=i&&i.dataset.decimals?i.dataset.decimals:"";function l(){t.value=s.filterNumber(t.value,[a])}t.addEventListener("focus",l),t.addEventListener("input",l),t.addEventListener("paste",l),t.addEventListener("blur",(()=>{t.value=r?s.filterFormattedQuantity(t.value,r,a,parseInt(o)):s.filterNumber(t.value)}))})),this.form.querySelectorAll(".form__field.--money-amount input").forEach((t=>{const s=this,i=e({element:t,className:"form__field"}),r=i&&i.dataset.currency?i.dataset.currency:"$",a=i&&i.dataset.thousandsSeparator?i.dataset.thousandsSeparator:".",o=i&&i.dataset.decimalSeparator?i.dataset.decimalSeparator:"",l=i&&i.dataset.decimals?i.dataset.decimals:"";function n(){t.value=s.filterNumber(t.value,[o])}t.addEventListener("focus",n),t.addEventListener("input",n),t.addEventListener("paste",n),t.addEventListener("blur",(()=>{t.value=this.filterMoneyAmount(t.value,r,a,o,parseInt(l))}))})),this.form.querySelectorAll(".form__field.--phone input").forEach((t=>{t.addEventListener("input",(()=>{t.value=this.filterPhoneNumber(t.value)})),t.addEventListener("paste",(()=>{t.value=this.filterPhoneNumber(t.value)}))})),this.form.querySelectorAll(".form__toggle-password-visibility").forEach((t=>{t.addEventListener("click",this.togglePasswordVisibility(t))}))}}export{a as default};
